<!DOCTYPE html>

<html>
<head>
  <!-- ðŸ¦€ -->
  <title>ADC Graph</title>
  <script src="https://unpkg.com/vue@2"></script>
  <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
</head>

<body>

  <div id="app">
    <table width="100%">

      <tr valign="top">
        <td width="80">&nbsp;</td>

        <td width="500">
          <h1>Real-time ADC Graph</h1>

          <h2>{{ title }}</h2>

          <div id="divPlotly"></div>

          <!--
          <table width="100%" border="1">
            <thead>
              <tr>
                <th>Time</th>
                <th>Value</th>
              </tr>
            </thead>
            <tr valign="top"
              v-for="point in points" :key="point.t">
              <td>{{ point.t }}</td>
              <td>{{ point.v }}</td>
            </tr>
          </table>
          -->

          <button onclick="updateAdcData()">Update</button>
          <input type="checkbox" id="checkboxRecurring" onchange='onCBReChange(this)'>auto</input>
        </td>

        <td>&nbsp;</td>
      </tr>
    </table>
  </div>

  <script>
    var xhr;

    // Initialize the chart with empty data
    var trace = {
      x: [],
      y: [],
      mode: "lines",
      line: { color: "#17BECF" },
    };
    var layout = {
      title: "Real-Time Data",
      xaxis: { title: "Time" },
      yaxis: { title: "Value" },
    };
    Plotly.newPlot("divPlotly", [trace], layout);

    // Update the chart with new data
    updatePlotly = function (points) {
      for (var i = 0; i < points.length; i++) {
        //var time = new Date(points[i].t).toLocaleTimeString();
        var time = points[i].t;
        var value = points[i].v;
        Plotly.extendTraces("divPlotly", { x: [time], y: [value] }, [0]);
      }
    }

    // Update the ADC data every second
    updateAdcData = function () {
      xhr.onreadystatechange = function () {
        if (this.readyState == XMLHttpRequest.DONE
        &&  this.status == 200) {
          var response = JSON.parse(this.responseText);
          app.points = [];
          var now = new Date();
          for (var i = 0; i < response.length; i++) {
            var time = now - (response.length - i) * 10;  // 10 ms per point
            item = { t: time, v: response[i] };
            app.points.push(item);

            // Update the chart with new data
            updatePlotly(item);
          }
          app.points = response;  // Apply the new ADC data points to Vue object's data
        }
      }

      xhr.open("GET", "/GetADC.cgi", true);
      xhr.send(null);

      // Recursively call this function if checked
      recurring = document.getElementById("checkboxRecurring").checked;
      if (recurring) {
        setTimeout(updateAdcData, 1000, true);
      }
    }

    // On checkbox change, enable recurring update data if checked
    onCBReChange = function (checkbox) {
      if (checkbox.checked == true) {
        updateAdcData(true);
      }
    }

    // Vue
    var app = new Vue({
      el: '#app',
      data: {
        title: 'ADC Data:',
        points: [
          { t: '0', v: '0' },
          { t: '1', v: '0' },
          { t: '2', v: '0' },
        ],
      },
      //methods: {
      //  humanizeBoolean: function (b) {
      //    return b ? 'Yes' : 'No'
      //  },
      //},
      created: function () {
        console.log('Vue app created');
        xhr = new XMLHttpRequest();
        // updateAdcData();
      },
    })
  </script>

</body>
</html>
