<!DOCTYPE html>

<html>
<head>
  <!-- ðŸ¦€ -->
  <title>ADC Graph</title>
  <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
</head>

<body>

  <div id="app">
    <table width="100%">

      <tr valign="top">
        <td width="80">&nbsp;</td>

        <td width="1024">
          <h1>Real-time ADC Data</h1>

          <div id="divPlotly"></div>

          <button onclick="updateAdcData()">Update</button>
          <input type="checkbox" id="checkboxRecurring" onchange='onCBReChange(this)'>auto</input>
        </td>

        <td>&nbsp;</td>
      </tr>
    </table>
  </div>

  <script>
    const gettingPeriod = 1000;  // Every 1000 ms

    // Initialize the chart with empty data
    var trace = {
      x: [],
      y: [],
      mode: "lines",
      line: { color: "#17BECF" },
    };
    var layout = {
      // title: "Real-Time Data",
      xaxis: { title: "Time" },
      yaxis: { title: "Value" },
    };
    Plotly.newPlot("divPlotly", [trace], layout);

    // Update the chart with new data
    updatePlotly = function (point) {
      console.log(point);
      Plotly.extendTraces("divPlotly", { x: [[point.time]], y: [[point.value]] }, [0]);
    }

    // Update the ADC data every second
    var xhr = new XMLHttpRequest();

    time_format = function (t) {
      var dt = new Date(t);
      return dt.valueOf();
      return dt.toLocaleTimeString() + `.${dt.getMilliseconds()}`;
    }

    updateAdcData = function () {
      xhr.onreadystatechange = function () {
        if (this.readyState == XMLHttpRequest.DONE
        &&  this.status == 200) {

          // Update the chart with new data
          var response = JSON.parse(this.responseText);
          const now = Date.now();

          for (var i = 0; i < response.length; i++) {
            var t = now - (response.length-1 - i) * gettingPeriod / response.length;  // 10 ms per point
            const time = time_format(t);
            updatePlotly({ time: time, value: response[i] });
          }

          // Keep only data in a period to be visible
          var t_start = now - gettingPeriod * 10;
          var t_end = now;
          var timeRange = [ time_format(t_start), time_format(t_end) ];
          console.log(timeRange);          
          var plotlyView = {
            xaxis: {
              type: 'date',
              range: timeRange,
            },
          };
          Plotly.relayout("divPlotly", plotlyView);
        
        }
      }

      xhr.open("GET", "/GetADC.cgi", true);
      xhr.send(null);

      // Recursively call this function if checked
      recurring = document.getElementById("checkboxRecurring").checked;
      if (recurring) {
        setTimeout(updateAdcData, gettingPeriod, true);
      }
    }

    // On checkbox change, enable recurring update data if checked
    onCBReChange = function (checkbox) {
      if (checkbox.checked == true) {
        updateAdcData(true);
      }
    }
  </script>

</body>
</html>
